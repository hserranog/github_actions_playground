# Automatiza la creación de la rama release, verifica las pruebas y si son correctas mezclar con la rama master.
# - Hace checkout del repositorio
# - Mezcla la rama desarrolo a la rama release
# - Se descargan las dependencias de Python
# - Corren las Pruebas Unitarias
# - Si las pruebas Unitarias pasan, se mezcla la rama release a la rama main

name: Pipeline2
on:
  workflow_dispatch:
permissions:
  contents: write
jobs:
  job1:
    name: Pipeline1
    runs-on: ubuntu-latest
    steps:
    - name: Checkout de repositorio
      uses: actions/checkout@v2
    - name: Crear/Actualizar desarrollo -> release
      uses: tukasz/direct-merge-action@master
      with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          source-branch: desarrollo
          target-branch: release
          force: true    # se sobre escribe la rama release en caso de ya existir
    - name: Checkout rama release
      uses: actions/checkout@v4
      with:
        ref: release
    - name: Configuración de entorno de python
      uses: actions/setup-python@v2
      with:
          python-version: '3.8'
    - name: Instalación de librerías y dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Correr pruebas
      id: correr-pruebas
      run: python -m unittest discover -s tests
    - name: Mezcla release -> main
      if: success()    # Solo si las pruebas pasan
      uses: tukasz/direct-merge-action@master
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        source-branch: release
        target-branch: main